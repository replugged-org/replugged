const { React, getModuleByDisplayName } = require('powercord/webpack');
const FormItem = require('./FormItem');

class Recorder extends getModuleByDisplayName('KeybindRecorder', false) {
  render () {
    const res = super.render();

    if (!this.__overwritten) {
      this.__overwritten = true;
      const original = res.props.registerNativeRecorder;

      res.props.registerNativeRecorder = (id, cb) => {
        const doc = this.props.document ?? document;
        let unlisten;

        PowercordNative.trickRegisterUserInteractionHandler((id, type, callback) => {
          const el = doc.getElementById(id);
          const handler = (ev) => callback(ev);
          el.addEventListener(type, handler);

          return () => el.removeEventListener(type, handler);
        }, () => {
          unlisten = original(id, cb);
        });

        return () => unlisten?.();
      };
    }

    return res;
  }
}

module.exports = class KeybindRecorder extends React.PureComponent {
  render () {
    return (
      <FormItem title={this.props.children} note={this.props.note} required={this.props.required}>
        <Recorder className="width50-3eScY6 section-1bCz6u" defaultValue={this.props.defaultValue} onChange={this.props.onChange} document={this.props.document} />
      </FormItem>
    );
  }
};
